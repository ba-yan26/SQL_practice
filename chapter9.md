## トランザクション
----

- トランザクションとは
  - DBmsに対して複数のSQL文を送る際、1つ以上のSQL文を一塊として扱うよう指示することができる。この塊をトランザクションという。
- トランザクション制御
  - トランザクションの途中で、処理が中断されないようにする
  - トランザクションの途中に、他の人の処理が割り込めないようにする

- トランザクションを使うための指示
  - BEGIN：開始の指示。この指示以降のSQL文を１つのトランザクションとする
  - COMMIT：終了の指示。この指示までを１つのトランザクションとし、変更を確定する。
  - ROLLBACK：終了の指示。この指示までを１つのトランザクションとし、変更の取り消しをする。

- 3つの代表的な副作用
  - ダーティリード：まだコミットされていない未確定の変更を、他の人が読めてしまうという副作用
  - 反復不能読み取り：あるテーブルに対してselect文を実行した後、他の人がupdate文でデータを書き換えると、次回selectした際に検索結果が異なってしまうという副作用
  - ファントムリード：2回のselect文の間に、他の人がinsert文で行を追加すると、2回のselectで結果行数が変わってしまう副作用

#### トランザクションの分離

- トランザクション分離レベル
  - READ UNCOMMITTED：`ダーティリード => 恐れあり, 反復不能読み取り => 恐れあり, ファントムリード => 恐れあり`
  - READ COMMITTED：`ダーティリード => 発生しない, 反復不能読み取り => 恐れあり, ファントムリード => 恐れあり`
  - REPEATABLE READ：`ダーティリード => 発生しない, 反復不能読み取り => 発生しない, ファントムリード => 恐れあり`
  - SERIALIZABLE：`ダーティリード => 発生しない, 反復不能読み取り => 発生しない, ファントムリード => 発生しない`

- トランザクション分離レベルの指定
  ```
  set transaction isolation level 分離レベル名
  set current isolation 分離レベル名
  ```

#### ロックの活用

- 明示的に取得できるロックの種類
  - 行ロック：ある特定の1行だけをロックする
  - 表ロック：ある特定のテーブル全体をロックする
  - データベースロック：データベース全体をロックする
- ロックを開ける際に厳しさを指定することができる
  - 排他ロック：他からのロックを一切許可しないため、主にデータの更新時に利用される。
  - 共有ロック：他からの共有ロックを許す特性があるため、データの読み取り時に多く利用されます。

  1. 行ロックの取得 - select ~ for update
  - 例
  ```
  begin;
  select * from テーブル名
  where 日付 >= '2022-02-01'
  for update;    -- 2月以降のデータを明示的にロック
  -- 集計処理1
  select ~ ;
  -- 集計処理2
  select ~ ;
  -- 集計処理3
  select ~ ;
  commit;
  ```

  2. 表ロックの取得 - lock table
  ```
  lock table テーブル名 in モード名 mode (nowait)
  ```
  `モード名はexclusiveで排他ロック、shareで共有ロックとなる`
  ```
  begin;
  lock table テーブル名 in exclusive mode;    --表を明示的ロック
  -- 集計処理1
  select ~ ;
  -- 集計処理2
  select ~ ;
  -- 集計処理3
  select ~ ;
  commit;
  ```

  - デッドロック
    - データベースで同時にたくさんのトランザクションが実行されると、まれにデッドロックと呼ばれる状態に陥り、トランザクションの処理が途中で永久に止まってしまうことがある。