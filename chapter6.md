## 集計とグループ化
----

### 集計
----
- 代表的な集計関数
  - SUM 各行の値の合計を求める
  - max 各行の値の最大値を求める
  - min 各行の値の最小値を求める
  - avg 各行の値の平均値を求める
  - count 行数をカウントする

- 例(sum,max,min,avg)
```
select
  sum(出金額) as 合計出金額,
  avg(出金額) as 平均出金額,
  max(出金額) as 最大出金額,
  min(出金額) as 最小出金額
from 家計簿
```

- 検索結果の行巣を求める(count関数)
  - count(*) => 検索結果の行数(nullも含めてカウントする)
  - count(列) => 検索結果の指定列に関する行数(指定列の値がnullである行を無視してカウントする)

- 例(count)
```
select count(*) as 食費の行数
  from 家計簿
  where 費目 = '食費'
```

### グループ化
----

- グループ化してそれぞれの合計を求める
```
select グループ化の基準列名, 集計関数 as 別名
  from テーブル名
  (where 絞り込み条件)
  group by グループ化の基準列名
```

- having句
  - 集計処理を行なった後の結果表に対して絞り込みを行う
  `(where句では集計処理が終わっていないので使えない)`
```
select グループ化の基準列名•••, 集計関数
from テーブル名
(where 元の表に対する絞り込み条件)
group by グループ化の基準列名
having句 集計結果に対する絞り込み条件
```

練習問題
----

1. 日本全体としての年間降水量と、年間の最高気温・最低気温の平均
```
select
  sum(降水量), avg(最高気温), avg(最低気温)
from 都市別気象観測
```

2. 東京の年間降水量と、最高気温、最低気温の平均温度
```
select
  sum(降水量), avg(最高気温), avg(最低気温)
  from 都市別気象観測
  where 都市名 = '東京'
```

3. 各都市の降水量の平均と、最も低かった最高気温、最も高かった最低気温
```
select 都市名
  avg(降水量), min(最高気温), max(最低気温)
  from 都市別気象観測
  group by 都市名
```

4. 月別の降水量、最高気温、最低気温の平均
```
select 月
  avg(降水量), avg(最高気温), avg(最低気温)
  from 都市別気象観測
  group by 月
```

5. 1年間で最も高い最高気温が38度以上を記録した月のある都市名とその気温
```
select 都市名, max(最高気温)
  from 都市別気象観測
  group by 都市名
  having max(最高気温) >= 38
```

6. 1年間で最も低い最低気温が-10度以下を記録した月のある都市名とその気温
```
select 都市名, min(最低気温)
  from 都市別気象観測
  group by 都市名
  having min(最低気温) <= -10
```

7. 現在入室中の社員数を取得する
```
select count(*) as 社員数
  from 入退室管理
  where 退室 is null
```

8. 社員ごとの入室回数を、回数の多い順に取得する
```
select 社員名, count(*) as 入室回数
  from 入退室管理
  group by 社員名
  order by 2 desc
```

9. 事由区分ごとの入室回数を取得する。その際、事由区分はわかりやすい表記とすること
```
select
  case 事由区分
    when '1' then 'メンテナンス'
    when '2' then 'リリース作業'
    when '3' then '障害対応'
    when '9' then 'その他'
  end as 事由, count(*) as 入室回数
  from 入退室管理
  group by 事由区分
```

10. 入室回数が10回を超過する社員について、社員名と入室回数を取得する
```
select 社員名, count(*) as 入室回数
  from 入退室管理
  group by 社員名
  having count(*) > 10
```

11. これまでに障害対応が発生した日付と、それぞれの障害に対応した社員数を取得する
```
select 日付, count(社員名) as 社員数
  from 入退室管理
  where 事由区分 = '3'
  group by 日付
```