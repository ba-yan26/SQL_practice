## 検索結果の加工
----
- select文専用の修飾がある
- select文によって得られた検索結果を様々な形に加工するためのもの


検索結果を加工する主なキーワード
----
- DISTINCT
  - 検索結果から重複行を除外する
- ORDER BY
  - 検索結果の順序を並び替える
- OFFSET-FETCH
  - 検索結果から件数を限定して取得する
- UNION
  - 検索結果に他の検索結果を足し合わせる
- EXCEPT
  - 検索結果から他の検索結果を差し引く
- INTERSECT
  - 検索結果と他の検索結果で重複する部分を取得する

DISTINCT
----
#### 重複行を除外する
 - データの種類を取得したい時に役に立つ

```
select distinct 列名...
  from テーブル名
```

ORDER BY
----
#### 検索結果を並び替える

```
select 列名
  from テーブル名
  order by 列名 並び順
```

- 昇順にする場合は`asc`
- 降順にする場合は`desc`

#### 複数の列を基準にした並び替え

```
select 列名
  from テーブル名
  order by 列名 並び順, 列名 desc
```
- 最初に指定した列名で並び替えを行った後に、同じ値があった場合は二つ目の列名を指定してそこで並び替えを指定することができる。

OFFSET-FETCH
----
#### 先頭から数件だけを取得する
##### `offset-fetchに対応していないDBMSがあるので注意`

```
select 列名...
  from テーブル名
  offset 先頭から除外する行数 rows
  (fetch next 取得行数 rows only)
```

- offset句には先頭から除外したい行数を記述する。除外はできないので1件目から取得した場合は`0`を指定する。
- fetch句には取得したい行数を記述する。記述を省略すると該当全てを取得する。
  - 11行目から15行目を取得した場合
  ```
  offset 10 rows
  fetch next 5 rows only
  ```

集合演算子
----
#### select命令によって抽出した結果票を１つのデータの集合と捉え、その結果同士を足し合わせたり、共通部分を探したりと様々な演算を行ってくれる

### UNION演算子 (和集合)
- 2つのselect文をUNIONで繋いで記述するとそれぞれの検索結果を足し合わせた結果(和集合)が返される
- union allではなくunionだけの場合は重複するデータは抽出されない

```
select 文1
  union (all)
select 文2
```

### EXCEPT演算子 (差集合)
- あるselect文の検索結果に存在する行から、別のselect文の検索結果に存在する行を差し引いた集合となる
- union演算子は足し合わせるだけなので文の順番に決まりはないが、except演算子はどの文を基準にするかで結果が変わるので注意が必要

```
select 文1
  except (all)
select 文2
```

### INTERSECT演算子 (積集合)
- 2つの文に共通する行を集める集合

```
select 列名... from テーブル名
  intersect (all)
select 列名... from テーブル名
```


練習問題
----

1. 注文順かつその明細順に、すべての注文データを取得する
```
select *
  from 注文履歴
  order by 注文番号 注文枝番
```

2. 2018年1月に注文のあった商品名の一覧を商品名順に取得する
```
select distinct 商品名
  from 注文履歴
  where 日付 >= '2018-01-01' and 日付 <= '2018-01-31'
  order by 商品名
```

3. ドリンクの商品を対象に、注文金額の低い方から2~4番目の注文の注文番号と注文枝番、注文金額を取得する
```
select 注文番号, 注文枝番, 注文金額
 from 注文履歴
 where 分類 = '1'
 order by 注文金額
 offset 1 rows
 fetch next 3 rows only
```

4. その他商品について、2つ以上同時に購入された商品を取得し、日付、商品名、単価、数量、注文金額を購入日順に表示する。ただし、同日に売り上げたものは、数量を多い順にする
```
select 日付, 商品名, 単価, 数量, 注文金額
  from 注文履歴
  where 分類 = '3'
  and 数量 >= 2
  order by 日付, 数量 desc
```

5. 商品の分類ごとに、分類、商品名、サイズ、単価を一つの表として取得する。また、サイズはドリンクの商品についてのみ表示し、分類と商品順に並べる
```
select distinct 分類, 商品名, サイズ, 単価
  from 注文履歴
  where 分類 = '1' union
select distinct 分類, 商品名, null, 単価
  from 注文履歴
  where 分類 = '2' union
select distinct 分類, 商品名, null, 単価
  from 注文履歴
  where 分類 = '3'
  order by 1, 2
```